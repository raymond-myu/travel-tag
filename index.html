<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>我的旅行足迹地图</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f7fa;
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
    }
    #search-container {
      width: 100%;
      max-width: 400px;
      margin: 0 auto 10px;
      display: flex;
      gap: 5px;
    }
    #search-input {
      flex: 1;
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    #search-btn {
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      background: #3498db;
      color: white;
      cursor: pointer;
      font-size: 16px;
    }
    #map-container {
      position: relative;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
    }
    #map {
      width: 100%;
      height: 600px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #dde6f0;
    }
    .zoom-controls {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      flex-direction: column;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 5px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }
    .zoom-controls button {
      border: none;
      background: #ffffff;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      border-bottom: 1px solid #ccc;
    }
    .zoom-controls button:last-child {
      border-bottom: none;
    }
    .zoom-controls button:hover {
      background: #f0f0f0;
    }
    .tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
    }

    /* 进度条样式 */
    #progress-container {
      width: 100%;
      max-width: 1200px;
      height: 25px;
      background: #ccc;
      border-radius: 12px;
      margin: 15px auto 0;
      overflow: hidden;
    }
    #progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #ff9a9e, #fad0c4);
      border-radius: 12px 0 0 12px;
      transition: width 0.5s ease;
    }
    #progress-text {
      text-align: center;
      margin-top: 5px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>我的旅行足迹地图</h1>
  <div id="search-container">
    <input id="search-input" placeholder="输入国家名搜索">
    <button id="search-btn">搜索</button>
  </div>
  <div id="map-container">
    <svg id="map"></svg>
    <div class="zoom-controls">
      <button id="zoom-in">+</button>
      <button id="zoom-out">−</button>
      <button id="reset-zoom">⟳</button>
    </div>
  </div>

  <!-- 进度条 -->
  <div id="progress-container">
    <div id="progress-bar"></div>
  </div>
  <div id="progress-text">已访问国家: 0 / 0 (0%)</div>

  <div class="tooltip" id="tooltip"></div>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/topojson-client@3"></script>
  <script>
    const svg = d3.select("#map");
    const tooltip = document.getElementById("tooltip");
    const width = svg.node().clientWidth;
    const height = svg.node().clientHeight;

    const projection = d3.geoMercator().scale(130).translate([width / 2, height / 1.5]);
    const path = d3.geoPath().projection(projection);
    let visited = {}; // 初始无任何标记

    const g = svg.append("g");
    const zoom = d3.zoom()
      .scaleExtent([1, 10])
      .on("zoom", event => g.attr("transform", event.transform));
    svg.call(zoom);

    let countriesData = [];
    let totalCountries = 0;

    // 加载世界地图
    d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-50m.json").then(worldData => {
      countriesData = topojson.feature(worldData, worldData.objects.countries).features;
      totalCountries = countriesData.length;

      g.selectAll("path")
        .data(countriesData)
        .enter()
        .append("path")
        .attr("d", path)
        .attr("class", "country")
        .attr("fill", "#b0c4de") // 初始浅色
        .attr("stroke", "#7f8c8d")
        .attr("stroke-width", 0.5)
        .on("click", (event, d) => {
          toggleCountry(d.id.toString(), event.currentTarget);
        })
        .on("mouseover", (event, d) => {
          tooltip.innerHTML = d.properties.name || "Unknown";
          tooltip.style.opacity = 1;
          tooltip.style.left = event.pageX + 10 + "px";
          tooltip.style.top = event.pageY - 30 + "px";
        })
        .on("mouseout", () => {
          tooltip.style.opacity = 0;
        });
      
      updateProgress(); // 初始化进度
    });

    function toggleCountry(id, element) {
      if (visited[id]) {
        delete visited[id];
        d3.select(element).attr("fill", "#b0c4de"); // 变回浅色
      } else {
        visited[id] = true;
        d3.select(element).attr("fill", "#ff69b4"); // 粉红色
      }
      updateProgress();
    }

    function updateProgress() {
      const visitedCount = Object.keys(visited).length;
      const percentage = totalCountries > 0 ? Math.round((visitedCount / totalCountries) * 100) : 0;
      const progressBar = document.getElementById("progress-bar");
      const progressText = document.getElementById("progress-text");
      progressBar.style.width = percentage + "%";
      progressText.textContent = `已访问国家: ${visitedCount} / ${totalCountries} (${percentage}%)`;
    }

    function doSearch() {
      const query = document.getElementById("search-input").value.trim().toLowerCase();
      if (!query) return;
      const match = countriesData.find(d => (d.properties.name || "").toLowerCase().includes(query));
      if (match) {
        const el = g.selectAll("path").filter(d => d.id === match.id);
        if (!el.empty()) {
          toggleCountry(match.id.toString(), el.node());
          const bounds = path.bounds(match);
          const dx = bounds[1][0] - bounds[0][0];
          const dy = bounds[1][1] - bounds[0][1];
          const x = (bounds[0][0] + bounds[1][0]) / 2;
          const y = (bounds[0][1] + bounds[1][1]) / 2;
          const scale = Math.max(1, Math.min(10, 0.9 / Math.max(dx / width, dy / height)));
          const translate = [width / 2 - scale * x, height / 2 - scale * y];
          svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
        }
      } else {
        alert("未找到国家：" + query);
      }
    }

    document.getElementById("search-btn").addEventListener("click", doSearch);
    document.getElementById("search-input").addEventListener("keydown", e => { if (e.key === "Enter") doSearch(); });

    document.getElementById("zoom-in").addEventListener("click", () => svg.transition().duration(500).call(zoom.scaleBy, 1.5));
    document.getElementById("zoom-out").addEventListener("click", () => svg.transition().duration(500).call(zoom.scaleBy, 0.7));
    document.getElementById("reset-zoom").addEventListener("click", () => svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity));
  </script>
</body>
</html>
